<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png"
        type="image/png">
    <title>Six Continents in 16 Days - Contest Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Landing Page Styles */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
        }

        .landing-hero {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            max-width: 800px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .landing-title {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.1;
        }

        .landing-subtitle {
            font-size: 1.5rem;
            margin-bottom: 30px;
            opacity: 0.95;
            font-weight: 500;
        }

        .landing-features {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .landing-feature {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }

        .landing-feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .landing-feature-text {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .play-game-btn {
            background: #C90F1A;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(201, 15, 26, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .play-game-btn:hover {
            background: #a50e16;
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(201, 15, 26, 0.6);
        }

        .prize-highlight {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
            font-size: 2rem;
            margin: 20px 0;
        }

        .stage-panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stage-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .stage-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 18px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 16px;
            background: #f0f0f0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .answer-input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        .answer-input:focus {
            border-color: #C90F1A;
            box-shadow: 0 0 0 3px rgba(201, 15, 26, 0.1);
        }

        .submit-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            background: #C90F1A;
            color: white;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #a50e16;
            transform: translateY(-1px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #c62828;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .success-panel {
            display: none;
            margin-top: 20px;
            padding: 16px;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            background: #f8fff9;
            border-color: #4caf50;
        }

        .success-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #2e7d32;
        }

        .success-text {
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .continue-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            background: #C90F1A;
            color: white;
            transition: all 0.2s;
        }

        .continue-btn:hover {
            background: #a50e16;
        }

        .second-riddle-panel {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #ffa726;
            border-radius: 12px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .second-riddle-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #e65100;
        }

        .second-riddle-clue {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
            color: #bf360c;
        }

        .journey-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .journey-title {
            font-weight: 800;
            font-size: 22px;
        }

        .journey-count {
            opacity: 0.8;
            font-size: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #666;
        }

        .user-name {
            font-weight: 600;
            color: #2e7d32;
        }

        .sign-out-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .sign-out-btn:hover:not(:disabled) {
            border-color: #C90F1A;
            color: #C90F1A;
            background: #fff5f5;
        }

        .sign-out-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.55);
            border-radius: 999px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #d7263d;
            border-radius: inherit;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* FIXED: Force 3-column grid layout for stages 1-15 */
        .stages-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 18px !important;
            width: 100% !important;
        }

        .stage-tile {
            border: 1px solid #ddd;
            background: #fafafa;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 140px;
            width: 100%;
        }

        .stage-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stage-tile.solved {
            border-color: #cde7cf;
            background: #f1fbf3;
            box-shadow: 0 10px 16px rgba(18,140,27,0.08);
        }

        .stage-tile.locked {
            border-color: #eee;
            background: #f8f8f8;
            cursor: not-allowed;
        }

        .stage-tile.locked:hover {
            transform: none;
        }

        .stage-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .stage-icon.solved {
            background: #128c1b;
        }

        .stage-icon.open {
            background: #C90F1A;
        }

        .stage-icon.locked {
            background: #bbb;
        }

        .stage-name {
            font-weight: 800;
            color: #222;
        }

        .stage-status {
            font-size: 12px;
            opacity: 0.75;
        }

        /* Prize Badge Styles */
        .prize-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 2;
            background: linear-gradient(135deg, #6B9B6B 0%, #4A7C4A 100%);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2px;
            padding: 6px 10px;
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18), 0 1px 2px rgba(0, 0, 0, 0.12);
            text-align: center;
            line-height: 1.2;
            min-width: 60px;
            transition: transform 200ms ease-out;
            cursor: pointer;
        }

        .prize-badge:hover {
            transform: scale(1.03);
        }

        .prize-badge-line {
            display: block;
        }

        /* Stage 16 separate container */
        .stage16-container {
            margin-top: 24px;
            display: flex;
            justify-content: center;
        }

        .stage16-card {
            width: clamp(360px, 72%, 760px);
            padding: 20px;
            border-radius: 16px;
            background: linear-gradient(180deg, #fff 0%, #ffe9e9 100%);
            border: 1px solid rgba(220, 0, 0, 0.18);
            box-shadow: 0 8px 24px rgba(220,0,0,0.10);
            transition: all 0.2s ease;
            position: relative;
        }

        .stage16-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(220,0,0,0.16);
        }

        .stage16-card.locked {
            filter: grayscale(.25);
            opacity: .9;
            cursor: not-allowed;
        }

        .stage16-card.locked:hover {
            transform: none;
            box-shadow: 0 8px 24px rgba(220,0,0,0.10);
        }

        .stage16-top {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stage16-left {
            display: flex; 
            align-items: center; 
            gap: 12px;
        }

        .stage16-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .stage16-icon.locked {
            background: #bbb;
        }

        .stage16-icon.open {
            background: #128c1b;
        }

        .stage16-title { 
            font-weight: 800; 
            font-size: 18px; 
        }

        .stage16-status { 
            font-size: 14px; 
            opacity: .9; 
            text-align: center;
        }

        .stage16-prize {
            background: #111; 
            color: #fff; 
            font-weight: 700;
            border-radius: 999px; 
            padding: 6px 12px; 
            font-size: 13px; 
            line-height: 1;
            box-shadow: 0 4px 14px rgba(0,0,0,.18);
        }

        /* Leaderboard Styles - FIXED */
        #leaderboard-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        #leaderboard-title {
            font-weight: 800;
            font-size: 22px;
            margin-bottom: 20px;
            color: #333;
        }

        .leaderboard-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)) !important;
            gap: 14px !important;
            width: 100% !important;
        }

        /* Card base */
        .lb-card {
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.10);
            padding: 14px;
            background: #fff;
            transition: all 0.2s;
            position: relative;
            min-height: 140px;
            border: 1px solid #eee;
        }

        .lb-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        /* Top row */
        .lb-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Winner/placeholder pill */
        .lb-pill {
            display: inline-block;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            line-height: 1;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .lb-pill.win {
            background: rgba(255,230,160,.32);
            color: #7a5500;
        }

        .lb-pill.none {
            background: rgba(0,0,0,.06);
            color: #333;
        }

        /* Left icon (lock/check) */
        .lb-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lb-icon {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.04);
            font-size: 14px;
        }

        .lb-icon.lock {
            background: #e9e9e9;
            color: #6b6b6b;
        }

        .lb-icon.check {
            background: #17b169;
            color: #fff;
        }

        .lb-title {
            font-weight: 800;
            margin: 6px 0 2px 0;
            color: #222;
        }

        /* Footer: prize badge bottom-left + status right */
        .lb-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .lb-prize-badge {
            order: -1;
            background: linear-gradient(135deg, #6B9B6B 0%, #4A7C4A 100%);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.2px;
            padding: 4px 8px;
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            text-align: center;
            line-height: 1.2;
        }

        .lb-status {
            font-size: 13px;
            opacity: .9;
            text-align: center;
        }

        .lb-date {
            font-size: 11px;
            opacity: .75;
            display: block;
            margin-top: 2px;
        }

        /* Username truncation */
        .lb-username {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 600;
        }

        /* LEADERBOARD:CSS:START */
        /* Stage 16 Big Leaderboard Card - CENTERED AND SPACED */
        .lb16-row {
            display: flex;
            justify-content: center;
            margin-top: 32px; /* Increased spacing from other cards */
            width: 100%;
        }

        .lb16-card {
            width: clamp(360px, 72%, 760px);
            padding: 20px;
            border-radius: 16px;
            background: linear-gradient(180deg, #fff 0%, #ffe9e9 100%);
            border: 1px solid rgba(220, 0, 0, 0.18);
            box-shadow: 0 8px 24px rgba(220,0,0,0.10);
            transition: all 0.2s ease;
            position: relative;
        }

        .lb16-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(220,0,0,0.16);
        }

        .lb16-top {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .lb16-left {
            display: flex; 
            align-items: center; 
            gap: 12px;
        }

        .lb16-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .lb16-icon.locked {
            background: #bbb;
        }

        .lb16-icon.open {
            background: #128c1b;
        }

        .lb16-title { 
            font-weight: 800; 
            font-size: 18px; 
        }

        .lb16-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .lb16-status { 
            font-size: 14px; 
            opacity: .9; 
            text-align: center;
        }

        .lb16-date {
            font-size: 11px;
            opacity: .75;
            display: block;
            margin-top: 2px;
        }

        .lb16-prize {
            order: -1;
            background: linear-gradient(135deg, #6B9B6B 0%, #4A7C4A 100%);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2px;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18), 0 1px 2px rgba(0, 0, 0, 0.12);
            text-align: center;
            line-height: 1.2;
        }
        /* LEADERBOARD:CSS:END */

        /* FOOTER STYLES */
        .app-footer {
            margin-top: 32px;
            padding: 24px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #FFD166;
            font-size: 14px;
            text-decoration: none;
            opacity: 0.85;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }

        .footer-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .footer-separator {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* INFO MODAL STYLES */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            z-index: 10000;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .info-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .info-modal-content {
            background: linear-gradient(135deg, #5f47e3, #6b2dbd);
            border-radius: 12px;
            padding: 32px;
            width: 90%;
            max-width: 700px;
            height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            color: white;
            position: relative;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .info-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .info-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            line-height: 1.2;
            flex: 1;
            margin-right: 16px;
        }

        .info-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-modal-body {
            font-size: 14px;
            line-height: 1.5;
            color: white;
        }

        .info-modal-body h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 8px 0;
            color: #FFD166;
        }

        .info-modal-body ol {
            margin: 16px 0;
            padding-left: 20px;
        }

        .info-modal-body li {
            margin-bottom: 12px;
        }

        .info-modal-body p {
            margin-bottom: 12px;
        }

        .info-modal-body strong {
            color: #FFD166;
        }

        .info-modal-body a {
            color: #FFD166;
            text-decoration: underline;
            cursor: pointer;
        }

        .info-modal-body a:hover {
            opacity: 0.8;
        }

        /* Custom scrollbar for modal */
        .info-modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .info-modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .info-modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .info-modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            width: min(400px, 90%);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-weight: 800;
            font-size: 18px;
        }

        .close-btn {
            border: none;
            background: transparent;
            font-size: 22px;
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
            text-align: center;
        }

        .modal-message {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
        }

        /* Auth Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .auth-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-modal-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0 24px;
            border-bottom: 1px solid #eee;
            margin-bottom: 24px;
        }

        .auth-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .auth-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .auth-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .auth-tabs {
            display: flex;
            margin: 0 24px 24px 24px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            color: #666;
        }

        .auth-tab.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .auth-form {
            display: none;
            padding: 0 24px 24px 24px;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #4285F4;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-btn.primary {
            background: #4285F4;
            color: white;
        }

        .auth-btn.primary:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .auth-link {
            text-align: center;
            margin-top: 16px;
        }

        .auth-link a {
            color: #4285F4;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        .auth-message {
            margin: 16px 24px 0 24px;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .auth-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .auth-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .landing-hero {
                padding: 40px 20px;
            }

            .landing-title {
                font-size: 2.5rem;
            }

            .landing-features {
                gap: 20px;
            }

            /* Mobile: Switch to single column for stages grid */
            .stages-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .leaderboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
                gap: 12px !important;
            }

            .input-group {
                flex-direction: column;
                gap: 8px;
            }

            .answer-input {
                width: 100%;
            }

            .info-modal-content {
                padding: 20px;
            }

            .footer-separator {
                display: none;
            }

            .stage16-card {
                width: clamp(260px, 90%, 400px);
            }

            /* Mobile: Stage 16 Leaderboard Card */
            .lb16-card {
                width: clamp(260px, 90%, 400px);
            }
        }
    </style>
</head>

<body>
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <div class="landing-hero">
            <h1 class="landing-title">The Global Travel Game<br>You Can Actually Win!</h1>
            <p class="landing-subtitle">Six Continents. 16 Days. One Amazing Journey.</p>

            <div class="landing-features">
                <div class="landing-feature">
                    <span class="landing-feature-icon">üîç</span>
                    <div class="landing-feature-text">Solve Clues</div>
                </div>
                <div class="landing-feature">
                    <span class="landing-feature-icon">üîì</span>
                    <div class="landing-feature-text">Unlock Stages</div>
                </div>
                <div class="landing-feature">
                    <span class="landing-feature-icon">‚úàÔ∏è</span>
                    <div class="landing-feature-text">Win Miles</div>
                </div>
            </div>

            <div class="prize-highlight">Win 150,000<br>Turkish Airlines Miles</div>

            <button id="playGameBtn" class="play-game-btn">PLAY THE GAME!</button>
        </div>

        <!-- FOOTER SECTION -->
        <footer class="app-footer">
            <div class="footer-links">
                <a href="#" id="howToPlayLink">‚ùì How to Play the Game?</a>
                <span class="footer-separator">‚Ä¢</span>
                <a href="#" id="termsLink">‚öñÔ∏è Terms & Conditions</a>
            </div>
        </footer>
    </div>

    <!-- Game Container (Hidden Initially) -->
    <div id="gameContainer" class="container" style="display: none;">
        <!-- Current Stage Panel -->
        <div id="currentStage" class="stage-panel">
            <div class="stage-title">Stage 1 ‚Äî Start Your Journey</div>
            <div class="stage-subtitle">Watch closely. Listen carefully. Answers are lowercase, no spaces.</div>

            <div class="video-container">
                <iframe id="currentVideo"
                    src="https://www.youtube.com/embed/bGI0u0RlW34"
                    title="Stage Video"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>

            <div id="inputSection" class="input-group">
                <input id="answerInput"
                    type="text"
                    class="answer-input"
                    placeholder="type your answer‚Ä¶">
                <button id="submitBtn" class="submit-btn">Submit</button>
            </div>

            <div id="errorMessage" class="error-message">
                That's not it. Watch & listen again üëÄ
            </div>

            <div id="successPanel" class="success-panel">
                <div class="success-title">üéâ Correct!</div>
                <div id="successText" class="success-text">Stage 1 complete. Your journey has officially begun.</div>
                <button id="continueBtn" class="continue-btn">Continue to Stage 2</button>
            </div>

            <!-- Second Riddle Panel (for stages 5-15) -->
            <div id="secondRiddlePanel" class="second-riddle-panel">
                <div class="second-riddle-title">üéâ Congratulations! You're almost there. Just one last riddle to solve üòä</div>
                <div id="secondRiddleClue" class="second-riddle-clue">
                    <!-- This will be dynamically updated by JavaScript -->
                </div>
                <div class="input-group">
                    <input id="secondRiddleInput"
                        type="text"
                        class="answer-input"
                        placeholder="type your second answer‚Ä¶">
                    <button id="secondRiddleSubmit" class="submit-btn">Submit</button>
                </div>
                <div id="secondRiddleError" class="error-message">
                    That's not it. Watch & listen again üëÄ
                </div>
            </div>
        </div>

        <!-- Journey Progress -->
        <div class="journey-section">
            <div class="journey-header">
                <div class="journey-title">Your Journey</div>
                <div class="user-info">
                    <span id="userName" class="user-name"></span>
                    <button id="signOutBtn" class="sign-out-btn">Sign Out</button>
                </div>
                <div id="progressCount" class="journey-count">0 / 16 solved</div>
            </div>

            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>

            <div id="stagesGrid" class="stages-grid">
                <!-- Stages 1-15 will be populated by JavaScript -->
            </div>

            <!-- Stage 16 Container (Separate from main grid) -->
            <div class="stage16-container">
                <div id="stage16Card" class="stage16-card locked">
                    <div class="stage16-top">
                        <div class="stage16-left">
                            <div class="stage16-icon locked">üîí</div>
                            <div class="stage16-title">Stage 16</div>
                        </div>
                        <div class="stage16-prize">100K Miles</div>
                    </div>
                    <div class="stage16-status">Locked</div>
                </div>
            </div>
        </div>

        <!-- Stage Winners Leaderboard -->
        <!-- LEADERBOARD:HTML:START -->
        <section id="leaderboard-section" aria-labelledby="leaderboard-title">
            <h3 id="leaderboard-title">üèÜ Stage Winners Leaderboard</h3>
            <div class="leaderboard-grid" role="list"></div>
            
            <!-- Stage 16 Big Leaderboard Card - CENTERED AND SPACED -->
            <div id="leaderboard-stage16-row" class="lb16-row"></div>
        </section>
        <!-- LEADERBOARD:HTML:END -->

        <!-- FOOTER SECTION -->
        <footer class="app-footer">
            <div class="footer-links">
                <a href="#" id="howToPlayLinkGame">‚ùì How to Play the Game?</a>
                <span class="footer-separator">‚Ä¢</span>
                <a href="#" id="termsLinkGame">‚öñÔ∏è Terms & Conditions</a>
            </div>
        </footer>
    </div>

    <!-- Simple Modal for stage info only -->
    <div id="stageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div id="modalTitle" class="modal-title">Stage</div>
                <button id="closeModal" class="close-btn" aria-label="Close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="modal-message">
                    Go to the main stage panel above to watch the video and submit your answer.
                </div>
            </div>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div id="howToPlayModal" class="info-modal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h2 class="info-modal-title">‚ú® How to Play the 6-Continent Challenge Giveaway and WIN</h2>
                <button class="info-modal-close" onclick="howToPlayModal.close()">‚úñ</button>
            </div>
            <div class="info-modal-body">
                <ol>
                    <li><strong>Watch the Videos</strong> ‚Äì Over the course of the trip, 16 YouTube videos will be uploaded. In each video, Joel recites three riddles or clues. These lead to the answer you need to solve.</li>
                    
                    <li><strong>Solve the Riddle and Guess the Answer</strong> ‚Äì Each correct solution is your ticket forward and essentially the password that unlocks the next stage. Think of it like collecting keys as you move through the game.</li>
                    
                    <li><strong>Unlock the Hidden Webpage</strong> ‚Äì With the solution in hand, click on the stage link to solve the riddle. Enter the solution to unlock the next stage. If it does not unlock, keep trying until you get it right.</li>
                    
                    <li><strong>Instant Stage Win and Stage Draws</strong> ‚Äì The first person to crack a stage password wins $50 USD and a $100 vacation voucher. All others are entered into a stage draw for the same prizes.</li>
                    
                    <li><strong>Keep Moving Through All 16 Stages</strong> ‚Äì Video, code, website, prize ‚Äî repeat! The first person to solve Stage 15 wins 50,000 Turkish Airlines Miles.</li>
                    
                    <li><strong>The Final Riddle</strong> ‚Äì Solve the Stage 16 final puzzle to win the Grand Prize of 100,000 Turkish Airlines Miles.</li>
                    
                    <li><strong>It's Never Too Late to Join (Unless the Contest Is Over)</strong> ‚Äì You can join and solve until the Grand Prize has been won or the contest ends (June 30 2026).</li>
                </ol>
                
                <p style="margin-top: 24px; text-align: center;">
                    üìú See full <a onclick="howToPlayModal.close(); termsModal.open();">Terms & Conditions ‚Üí</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Terms & Conditions Modal -->
    <div id="termsModal" class="info-modal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h2 class="info-modal-title">‚öñÔ∏è Terms & Conditions ‚Äì 6 Continent Challenge Contest</h2>
                <button class="info-modal-close" onclick="termsModal.close()">‚úñ</button>
            </div>
            <div class="info-modal-body">
                <h3>1. Eligibility</h3>
                <p>Open to individuals aged 18 and older at the time of entry. Void where prohibited by law. Employees, contractors, and immediate family members of the organizers are not eligible to participate. Limit one entry per person. Multiple entries or attempts to circumvent entry limits may result in disqualification.</p>

                <h3>2. Contest Overview</h3>
                <p>The contest consists of 16 password-protected stages. Each video in the 6 Continent Challenge series contains clues that unlock a password. Participants must enter the correct password on the contest website and complete the acknowledgment form to advance. After completing the first 15 stages, participants will use all collected passwords to solve the final Stage 16 puzzle.</p>

                <h3>3. Prize Structure</h3>
                <p><strong>Grand & Bonus Prizes</strong> ‚Äî Grand Prize: 100,000 Turkish Airlines Miles awarded to the first participant to solve the final Stage 16 puzzle (subject to Section 4). Bonus Prize: 50,000 Turkish Airlines Miles awarded to the first participant who successfully unlocks the Stage 15 password.</p>
                
                <p><strong>Stage Prizes</strong> ‚Äî 15 total stages.</p>
                <p>First Correct Solver Prize: $50 USD cash (via WISE) + $100 USD Vacation Credit with MaravillaNayarit.com.</p>
                <p>Stage Draw Prize: All participants who advance past a stage are automatically entered into a random draw for the same prizes.</p>
                
                <p>Notes: Cash prizes require a WISE account and WiseTag to claim. Winners can sign up for a WISE account via the provided link.</p>

                <h3>4. Airline Miles Disclaimer</h3>
                <p>The Grand and Bonus Prizes depend on Turkish Airlines awarding miles as part of the "One Million Miles" campaign. If Turkish Airlines cancels or refuses to award miles, the organizers are not liable and the prize is void. Miles cannot be transferred directly to winners; organizers will book flights on their behalf. Flights must be booked no later than December 31, 2026. All travel is subject to Turkish Airlines' rules and policies. Additional airline fees and taxes must be paid by the winner at booking. Any changes requested by the winner will incur a $150 USD fee per ticket plus airline charges.</p>

                <h3>5. Entry & Verification</h3>
                <p>Participants must solve each stage puzzle, submit the correct password, and complete the acknowledgment form to advance. The first correct solver is determined by the timestamp (UTC) of form submission. Stage Draw entries include all participants who advance past that stage. Grand and Bonus Prize winners must have successfully completed all 15 stages and riddles.</p>

                <h3>6. Contest Duration</h3>
                <p>The contest begins with the release of the first video and officially closes on June 30, 2026 if no Grand Prize winner has been declared earlier.</p>

                <h3>7. Publicity</h3>
                <p>By participating, entrants agree that the organizers may use their names, social media handles, likenesses, and country of residence in promotional materials without additional compensation, unless prohibited by law.</p>

                <h3>8. Taxes & Fees</h3>
                <p>Winners are responsible for any taxes, fees, or charges associated with their prizes. For airline bookings, winners must cover airport taxes and surcharges not included in the miles award.</p>

                <h3>9. General Conditions</h3>
                <p>By participating, entrants agree to these Terms & Conditions. The organizers may modify, suspend, or terminate the contest in the event of unforeseen circumstances. Decisions of the organizers are final and binding in all matters. The organizers are not responsible for technical issues, internet outages, or other errors that may affect participation or results.</p>

                <h3>10. Governing Law</h3>
                <p>The contest is governed by the laws of Canada and Mexico.</p>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h2 id="auth-title">Join the Game!</h2>
                <button class="auth-close" onclick="authUI.closeModal()">&times;</button>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="authUI.showTab('signup')">Sign Up</button>
                <button class="auth-tab" onclick="authUI.showTab('signin')">Sign In</button>
            </div>

            <div id="auth-signup" class="auth-form active">
                <form onsubmit="authUI.handleSignUp(event)">
                    <input type="text" id="signup-username" placeholder="Username" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required minlength="6">
                    <button type="submit" class="auth-btn primary">Create Account & Start Playing</button>
                </form>
            </div>

            <div id="auth-signin" class="auth-form">
                <form onsubmit="authUI.handleSignIn(event)">
                    <input type="email" id="signin-email" placeholder="Email" required>
                    <input type="password" id="signin-password" placeholder="Password" required>
                    <button type="submit" class="auth-btn primary">Sign In</button>
                </form>

                <p class="auth-link">
                    <a href="#" onclick="authUI.showForgotPassword()">Forgot your password?</a>
                </p>
            </div>

            <div id="auth-forgot" class="auth-form">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <form onsubmit="authUI.handleForgotPassword(event)">
                    <input type="email" id="forgot-email" placeholder="Email" required>
                    <button type="submit" class="auth-btn primary">Send Reset Link</button>
                </form>
                <p class="auth-link">
                    <a href="#" onclick="authUI.showTab('signin')">Back to Sign In</a>
                </p>
            </div>

            <div id="auth-message" class="auth-message"></div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script>
        // Global initialization guards to prevent circular dependencies
        window.__appInitialized = false;
        window.__gameShown = false;

        // Supabase Configuration
        const SUPABASE_URL = 'https://vlcjilzgntxweomnyfgd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsY2ppbHpnbnR4d2VvbW55ZmdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MTM0MzUsImV4cCI6MjA3NzQ4OTQzNX0.MeIJpGfdAGqQwx9t0_Tdog9W-Z1cWX3z4cUffeoQW-c';

        // Stage-specific second riddle clues
        const SECOND_RIDDLE_CLUES = {
            5: "We slept where Ra's first light awoke, In walls that held the desert's smoke. Seek not the tombs of kings long gone, But the humble door our fate shone on‚Äî Three numbers guard the path once more, The code that wakes the chamber door.",
            6: "From city skies to seaside song, Where golden butter makes you strong. The name is whispered, soft and gone, A coastal town where flavors dawn.",
            7: "A whisper called before we flew, A brand appeared, then left our view. The clue was fleeting, yet it's true‚Äî One word, four numbers‚Äîseen and heard by few.",
            8: "A sign of steel, a steady hand, The numbers bold, the prices stand. For blade and shear, combine their wit‚Äî Old phrase says, 'two bits!'",
            9: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            10: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            11: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            12: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            13: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            14: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge.",
            15: "This is just a placeholder (you can just use that for now and I can update stage by stage). If you get stuck, go back to the video on YouTube and comment that you need help! Joel will give you a nudge."
        };

        // Initialize Supabase client
        let supabase = null;
        let supabaseAuth = null;
        let progressManager = null;
        let leaderboardManager = null;
        let authUI = null;

        // Wait for Supabase to load
        function initializeSupabase() {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Initialize auth system
                supabaseAuth = {
                    user: null,
                    isAuthenticated: () => !!supabaseAuth.user,

                    async signInWithEmail(email, password) {
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        return data;
                    },

                    async signUpWithEmail(email, password, metadata = {}) {
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: { data: metadata }
                        });
                        if (error) throw error;
                        return data;
                    },

                    async resetPassword(email) {
                        const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                            redirectTo: window.location.origin
                        });
                        if (error) throw error;
                        return data;
                    },

                    async signOut() {
                        console.log('[AUTH] Sign out initiated...');
                        try {
                            const { error } = await supabase.auth.signOut();
                            if (error) {
                                console.error('[AUTH] Sign out error:', error);
                                throw error;
                            }
                            console.log('[AUTH] Sign out successful');
                            
                            // Clear user state immediately
                            supabaseAuth.user = null;
                            
                            // Clear local storage
                            localStorage.removeItem("contest_solved_stages");
                            localStorage.removeItem("contest_first_riddle_solved");
                            
                            // Force redirect to landing page
                            showLanding();
                            
                            return true;
                        } catch (error) {
                            console.error('[AUTH] Sign out failed:', error);
                            // Even if sign out fails, clear local state
                            supabaseAuth.user = null;
                            showLanding();
                            throw error;
                        }
                    }
                };

                // Auth state listener
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('[AUTH] State changed:', event, session?.user?.email);

                    if (session?.user) {
                        supabaseAuth.user = session.user;
                        if (progressManager) {
                            console.log('[AUTH] User signed in, syncing progress...');
                            await progressManager.syncWithSupabase();
                        }
                    } else {
                        console.log('[AUTH] User signed out, clearing state...');
                        supabaseAuth.user = null;
                        if (window.__gameShown) {
                            showLanding();
                        }
                    }
                });

                // Progress manager
                progressManager = {
                    async syncWithSupabase() {
                        if (!supabaseAuth.isAuthenticated()) {
                            console.log('[progressManager] User not authenticated, using local storage only');
                            return null;
                        }

                        try {
                            console.log('[progressManager] Syncing progress from cloud...');

                            const { data: solves, error } = await supabase
                                .from('solves')
                                .select('stage')
                                .eq('user_id', supabaseAuth.user.id)
                                .order('stage', { ascending: true });

                            if (error) {
                                console.warn('[progressManager] Failed to sync from cloud:', error);
                                return null;
                            }

                            if (solves && solves.length > 0) {
                                const cloudStages = solves.map(solve => solve.stage);
                                console.log('[progressManager] Found cloud progress:', cloudStages);

                                const localStages = window.contestApp ? window.contestApp.getSolvedStagesFromLocal() : [];
                                const mergedStages = [...new Set([...cloudStages, ...localStages])].sort((a, b) => a - b);

                                if (window.contestApp) {
                                    console.log('[progressManager] Updating contest app with merged progress:', mergedStages);
                                    window.contestApp.setSolvedStagesLocal(mergedStages);
                                    
                                    window.contestApp.renderStagesGrid();
                                    window.contestApp.updateProgress();
                                    window.contestApp.renderCurrentStage();
                                    
                                    console.log('[progressManager] UI updated with synced progress');
                                }

                                console.log('[progressManager] Progress synced successfully:', mergedStages);
                                return mergedStages;
                            } else {
                                console.log('[progressManager] No cloud progress found, using local storage');
                                return null;
                            }

                        } catch (error) {
                            console.warn('[progressManager] Cloud sync failed:', error);
                            return null;
                        }
                    },

                    async logStageCompletion(stage, answer, additionalData = {}) {
                        console.log('[progressManager] Local logging only:', { stage, answer });
                    }
                };

                // Leaderboard manager
                leaderboardManager = {
                    async logSolve(stage, maxRetries = 3) {
                        if (!supabaseAuth.isAuthenticated()) {
                            console.warn('[logSolve] User not authenticated, skipping database save');
                            return { success: true, reason: 'not_authenticated' };
                        }

                        let lastError = null;
                        
                        for (let attempt = 1; attempt <= maxRetries; attempt++) {
                            try {
                                console.log(`[logSolve] Attempt ${attempt}/${maxRetries} for stage ${stage}`);

                                const { data: { user }, error: userError } = await supabase.auth.getUser();
                                if (userError) {
                                    console.warn(`[logSolve] Auth error on attempt ${attempt}:`, userError);
                                    await supabase.auth.refreshSession();
                                    continue;
                                }

                                if (!user) {
                                    console.warn(`[logSolve] No user found on attempt ${attempt}`);
                                    return { success: true, reason: 'no_user' };
                                }

                                const payload = {
                                    stage: Number(stage),
                                    user_id: user.id,
                                    email: user.email || null,
                                    username: user.user_metadata?.username || (user.email?.split('@')[0] || 'guest')
                                };

                                console.log(`[logSolve] Inserting payload:`, payload);

                                const { data, error } = await supabase
                                    .from('solves')
                                    .upsert(payload, { 
                                        onConflict: 'user_id,stage',
                                        ignoreDuplicates: false 
                                    })
                                    .select()
                                    .single();

                                if (error) {
                                    lastError = error;
                                    console.warn(`[logSolve] Database error on attempt ${attempt}:`, error);
                                    
                                    if (error.code === '23505') {
                                        console.log(`[logSolve] Stage ${stage} already solved by user (duplicate key) - treating as success`);
                                        return { success: true, reason: 'already_solved' };
                                    }
                                    
                                    if (attempt < maxRetries) {
                                        const delay = Math.pow(2, attempt - 1) * 1000;
                                        console.log(`[logSolve] Retrying in ${delay}ms...`);
                                        await new Promise(resolve => setTimeout(resolve, delay));
                                        continue;
                                    }
                                } else {
                                    console.log(`[logSolve] Successfully saved stage ${stage} to database:`, data);
                                    return { success: true, data };
                                }

                            } catch (error) {
                                lastError = error;
                                console.warn(`[logSolve] Network error on attempt ${attempt}:`, error);
                                
                                if (attempt < maxRetries) {
                                    const delay = Math.pow(2, attempt - 1) * 1000;
                                    console.log(`[logSolve] Retrying in ${delay}ms...`);
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                }
                            }
                        }

                        console.error(`[logSolve] Failed to save stage ${stage} after ${maxRetries} attempts. Last error:`, lastError);
                        
                        return { 
                            success: true, 
                            reason: 'db_save_failed_but_allowing_progression',
                            error: lastError 
                        };
                    }
                };

                window.supabaseAuth = supabaseAuth;
                window.progressManager = progressManager;
                window.leaderboardManager = leaderboardManager;
            }
        }

        // FIXED: Leaderboard functionality - Ensure proper rendering
        function renderLbCard(stage, winner) {
            const hasWinner = !!winner;
            const pill = hasWinner
                ? `<span class="lb-pill win">Winner: <span class="lb-username">${winner.username || '‚Äî'}</span></span>`
                : `<span class="lb-pill none">No Winner Yet</span>`;

            // icon circle replaces the old red stage-number disc
            const icon = hasWinner
                ? `<span class="lb-icon check" aria-hidden="true">‚úî</span>`
                : `<span class="lb-icon lock" aria-hidden="true">üîí</span>`;

            const status = hasWinner
                ? `üéâ Congratulations!${winner.won_at ? `<span class="lb-date">Won ${new Date(winner.won_at).toLocaleDateString()}</span>` : ''}`
                : `Prize Still Available`;

            let prizeText;
            if (stage === 15) {
                prizeText = '50K Miles';
            } else {
                prizeText = '$50 + $100 GC';
            }

            const card = document.createElement('div');
            card.className = 'lb-card';
            card.setAttribute('role', 'listitem');

            card.innerHTML = `
                <div class="lb-top">
                    ${pill}
                </div>

                <div class="lb-left" style="margin-top:8px;">
                    ${icon}
                    <h4 class="lb-title">Stage ${stage}</h4>
                </div>

                <div class="lb-footer">
                    <div class="lb-prize-badge">${prizeText}</div>
                    <div class="lb-status">${status}</div>
                </div>
            `;

            return card;
        }

        // FIXED: Ensure leaderboard renders properly
        async function renderLeaderboard() {
            console.log('[LEADERBOARD] Starting leaderboard render...');

            const grid = document.querySelector('.leaderboard-grid');
            if (!grid) {
                console.warn('[LEADERBOARD] Grid element not found');
                return;
            }

            // Clear existing content first
            grid.innerHTML = '';

            let winnersMap = {};

            // Try to fetch winners data
            try {
                if (supabase) {
                    console.log('[LEADERBOARD] Fetching winners from stage_winners table...');
                    const { data, error } = await supabase
                        .from('stage_winners')
                        .select('stage, username, won_at')
                        .order('stage', { ascending: true });

                    if (error) {
                        console.warn('[LEADERBOARD] Error fetching winners:', error);
                    } else if (data && data.length > 0) {
                        console.log('[LEADERBOARD] Winners data received:', data);
                        data.forEach(winner => {
                            winnersMap[winner.stage] = winner;
                        });
                    } else {
                        console.log('[LEADERBOARD] No winners found in database');
                    }
                } else {
                    console.warn('[LEADERBOARD] Supabase not initialized');
                }
            } catch (error) {
                console.warn('[LEADERBOARD] Failed to fetch winners:', error);
            }

            console.log('[LEADERBOARD] Winners map:', winnersMap);

            // ALWAYS render cards for stages 1-15, even if no winners data
            for (let stage = 1; stage <= 15; stage++) {
                const winner = winnersMap[stage];
                const card = renderLbCard(stage, winner);
                grid.appendChild(card);
            }

            console.log('[LEADERBOARD] Successfully rendered 15 leaderboard cards');
        }

        <!-- LEADERBOARD:JS:START -->
        // LEAVE your existing renderLeaderboard() as-is.
        // Add a small helper to render the big Stage 16 card OUTSIDE the grid.

        async function renderLeaderboardStage16Big(){
            const row = document.getElementById('leaderboard-stage16-row');
            if (!row) return;

            // fetch just stage 16 (or fetch all once and filter if you already have data in scope)
            let winner = null;
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('stage_winners')
                        .select('stage, username, won_at')
                        .eq('stage', 16)
                        .limit(1);

                    if (error) {
                        console.warn('[LB16] query error', error);
                    } else if (data && data.length > 0) {
                        winner = data[0];
                    }
                }
            } catch (error) {
                console.warn('[LB16] Failed to fetch Stage 16 winner:', error);
            }

            const hasWinner = !!winner;

            const pill = hasWinner
                ? `<span class="lb-pill win">Winner: <span class="lb-username">${winner.username || '‚Äî'}</span></span>`
                : `<span class="lb-pill none">No Winner Yet</span>`;

            const icon = hasWinner
                ? `<span class="lb-icon check" aria-hidden="true">‚úî</span>`
                : `<span class="lb-icon lock" aria-hidden="true">üîí</span>`;

            const status = hasWinner
                ? `üéâ Congratulations!${winner.won_at ? `<span class="lb16-date">Won ${new Date(winner.won_at).toLocaleDateString()}</span>` : ''}`
                : `Prize Still Available`;

            const card = document.createElement('div');
            card.className = 'lb16-card';
            card.setAttribute('role', 'group');
            card.setAttribute('aria-label', 'Stage 16 (Leaderboard)');

            card.innerHTML = `
                <div class="lb16-top">
                    ${pill}
                    <!-- keep top-right clean -->
                </div>

                <div class="lb16-left" style="margin-top:8px;">
                    ${icon}
                    <h4 class="lb16-title">Stage 16</h4>
                </div>

                <div class="lb16-footer">
                    <div class="lb16-prize">100K Miles</div>
                    <div class="lb16-status">${status}</div>
                </div>
            `;

            row.innerHTML = '';
            row.appendChild(card);
        }
        <!-- LEADERBOARD:JS:END -->

        // Modal Management System
        const howToPlayModal = {
            element: null,
            
            init() {
                this.element = document.getElementById('howToPlayModal');
            },
            
            open() {
                if (this.element) {
                    this.element.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            },
            
            close() {
                if (this.element) {
                    this.element.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        };

        const termsModal = {
            element: null,
            
            init() {
                this.element = document.getElementById('termsModal');
            },
            
            open() {
                if (this.element) {
                    this.element.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            },
            
            close() {
                if (this.element) {
                    this.element.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
        };

        // Auth UI
        class AuthUI {
            showModal() {
                const modal = document.getElementById('auth-modal');
                modal.classList.add('show');
                this.showTab('signup');
            }

            closeModal() {
                const modal = document.getElementById('auth-modal');
                modal.classList.remove('show');
                this.clearMessage();
            }

            showTab(tab) {
                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.remove('active');
                });

                document.querySelectorAll('.auth-tab').forEach(tabBtn => {
                    tabBtn.classList.remove('active');
                });

                if (tab === 'signup') {
                    document.getElementById('auth-signup').classList.add('active');
                    document.querySelector('.auth-tab:first-child').classList.add('active');
                    document.getElementById('auth-title').textContent = 'Join the Game!';
                } else if (tab === 'signin') {
                    document.getElementById('auth-signin').classList.add('active');
                    document.querySelector('.auth-tab:last-child').classList.add('active');
                    document.getElementById('auth-title').textContent = 'Welcome Back!';
                }

                this.clearMessage();
            }

            showForgotPassword() {
                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.remove('active');
                });
                document.getElementById('auth-forgot').classList.add('active');
                document.getElementById('auth-title').textContent = 'Reset Password';
                this.clearMessage();
            }

            showMessage(message, type = 'info') {
                const messageEl = document.getElementById('auth-message');
                messageEl.textContent = message;
                messageEl.className = `auth-message ${type}`;
                messageEl.style.display = 'block';
            }

            clearMessage() {
                const messageEl = document.getElementById('auth-message');
                messageEl.style.display = 'none';
            }

            async handleSignIn(event) {
                event.preventDefault();
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;

                try {
                    this.showMessage('Signing in...', 'info');
                    await supabaseAuth.signInWithEmail(email, password);
                    this.showMessage('Welcome back!', 'success');
                    setTimeout(() => {
                        this.closeModal();
                        showGame();
                    }, 1500);
                } catch (error) {
                    console.error('Sign in error:', error);
                    this.showMessage(error.message || 'Failed to sign in', 'error');
                }
            }

            async handleSignUp(event) {
                event.preventDefault();
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;

                try {
                    this.showMessage('Creating your account...', 'info');
                    await supabaseAuth.signUpWithEmail(email, password, {
                        full_name: username,
                        username: username
                    });
                    this.showMessage('Account created! Let\'s start your journey!', 'success');
                    setTimeout(() => {
                        this.closeModal();
                        showGame();
                    }, 2000);
                } catch (error) {
                    console.error('Sign up error:', error);
                    this.showMessage(error.message || 'Failed to create account', 'error');
                }
            }

            async handleForgotPassword(event) {
                event.preventDefault();
                const email = document.getElementById('forgot-email').value;

                try {
                    this.showMessage('Sending reset link...', 'info');
                    await supabaseAuth.resetPassword(email);
                    this.showMessage('Password reset link sent! Check your email.', 'success');
                    setTimeout(() => this.showTab('signin'), 3000);
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showMessage(error.message || 'Failed to send reset link', 'error');
                }
            }
        }

        // Show/Hide functions
        function showLanding() {
            console.log('[UI] Showing landing page');
            window.__gameShown = false;
            document.getElementById('landingPage').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
        }

        function showGame() {
            if (window.__gameShown) {
                console.log('[UI] Game already shown, skipping');
                return;
            }
            
            console.log('[UI] Showing game');
            window.__gameShown = true;
            
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (supabaseAuth && supabaseAuth.user) {
                const userName = supabaseAuth.user.user_metadata?.username ||
                    supabaseAuth.user.user_metadata?.full_name ||
                    supabaseAuth.user.email.split('@')[0];
                document.getElementById('userName').textContent = userName;
            }

            // FIXED: Force leaderboard render when game is shown
            setTimeout(() => {
                console.log('[UI] Forcing leaderboard render...');
                renderLeaderboard();
                renderLeaderboardStage16Big();
            }, 500);
        }

        // Contest App Configuration
        const CONFIG = {
            total: 16,
            stages: {
                1: { title: "Stage 1", yt: "bGI0u0RlW34" },
                2: { title: "Stage 2", yt: "mQgZMa8sjYY" },
                3: { title: "Stage 3", yt: "KUN90a2ZHiw" },
                4: { title: "Stage 4", yt: "YIIR8guq-No" },
                5: { title: "Stage 5", yt: "sGqsQ7YyGPw" },
                6: { title: "Stage 6", yt: "Kv9js6bb35c" },
                7: { title: "Stage 7", yt: "LEZIW9LXwNA" },
                8: { title: "Stage 8", yt: "i81uGvAqi5c" },
                9: { title: "Stage 9", yt: "xxAU10mE0ik" },
                10: { title: "Stage 10", yt: "xxAU10mE0ik" },
                11: { title: "Stage 11", yt: "xxAU10mE0ik" },
                12: { title: "Stage 12", yt: "xxAU10mE0ik" },
                13: { title: "Stage 13", yt: "xxAU10mE0ik" },
                14: { title: "Stage 14", yt: "xxAU10mE0ik" },
                15: { title: "Stage 15", yt: "xxAU10mE0ik" },
                16: { title: "Stage 16", yt: "xxAU10mE0ik" }
            }
        };

        // Stage 16 Update Function
        function updateStage16() {
            const stage16Card = document.getElementById('stage16Card');
            if (!stage16Card) return;

            // Get solved stages from contestApp if available, otherwise from localStorage
            let solvedStages = [];
            if (window.contestApp && window.contestApp.getSolvedStagesFromLocal) {
                solvedStages = window.contestApp.getSolvedStagesFromLocal();
            } else {
                try {
                    solvedStages = JSON.parse(localStorage.getItem("contest_solved_stages") || "[]");
                } catch (e) {
                    solvedStages = [];
                }
            }

            const solved = new Set(solvedStages.filter(n => n >= 1 && n <= 15));
            const unlocked = solved.size === 15; // gate condition

            // Update the card classes and content
            if (unlocked) {
                stage16Card.classList.remove('locked');
                stage16Card.innerHTML = `
                    <div class="stage16-top">
                        <div class="stage16-left">
                            <div class="stage16-icon open">‚úî</div>
                            <div class="stage16-title">Stage 16</div>
                        </div>
                        <div class="stage16-prize">100K Miles</div>
                    </div>
                    <div class="stage16-status">Open</div>
                `;
                
                // Add click handler for open Stage 16
                stage16Card.style.cursor = 'pointer';
                stage16Card.onclick = () => {
                    if (window.contestApp && window.contestApp.openStageModal) {
                        window.contestApp.openStageModal(16);
                    }
                };
            } else {
                stage16Card.classList.add('locked');
                stage16Card.innerHTML = `
                    <div class="stage16-top">
                        <div class="stage16-left">
                            <div class="stage16-icon locked">üîí</div>
                            <div class="stage16-title">Stage 16</div>
                        </div>
                        <div class="stage16-prize">100K Miles</div>
                    </div>
                    <div class="stage16-status">Locked</div>
                `;
                stage16Card.style.cursor = 'not-allowed';
                stage16Card.onclick = null;
            }
        }

        // Contest App Class
        class ContestApp {
            constructor() {
                this.currentStage = 1;
                this.solvedStages = [];
                this.firstRiddleSolved = [];
                this.modalCurrentStage = null;
                this.init();
            }

            async init() {
                console.log('[ContestApp] Initializing...');
                this.loadInitialProgress();
                this.renderCurrentStage();
                this.renderStagesGrid();
                this.updateProgress();
                this.bindEvents();
                console.log('[ContestApp] Initialized');
            }

            loadInitialProgress() {
                this.solvedStages = this.getSolvedStagesFromLocal();
                this.firstRiddleSolved = this.getFirstRiddleSolvedFromLocal();
            }

            getSolvedStagesFromLocal() {
                try {
                    return JSON.parse(localStorage.getItem("contest_solved_stages") || "[]");
                } catch (e) {
                    return [];
                }
            }

            setSolvedStagesLocal(stages) {
                const unique = [...new Set(stages)].sort((a, b) => a - b);
                localStorage.setItem("contest_solved_stages", JSON.stringify(unique));
                this.solvedStages = unique;
            }

            getFirstRiddleSolvedFromLocal() {
                try {
                    return JSON.parse(localStorage.getItem("contest_first_riddle_solved") || "[]");
                } catch (e) {
                    return [];
                }
            }

            setFirstRiddleSolvedLocal(stages) {
                const unique = [...new Set(stages)].sort((a, b) => a - b);
                localStorage.setItem("contest_first_riddle_solved", JSON.stringify(unique));
                this.firstRiddleSolved = unique;
            }

            isSolved(stage) {
                return this.solvedStages.includes(stage);
            }

            isFirstRiddleSolved(stage) {
                return this.firstRiddleSolved.includes(stage);
            }

            isUnlocked(stage) {
                return stage === 1 || this.isSolved(stage - 1);
            }

            hasTwoRiddles(stage) {
                return stage >= 5 && stage <= 15;
            }

            getNextUnsolvedStage(fromStage) {
                for (let i = fromStage; i <= CONFIG.total; i++) {
                    if (!this.isSolved(i)) return i;
                }
                return null;
            }

            async markStageSolvedAndAdvance(stage) {
                console.log(`[ADVANCE] Marking stage ${stage} as solved and advancing...`);
                
                if (!this.isSolved(stage)) {
                    const newSolved = [...this.solvedStages, stage];
                    this.setSolvedStagesLocal(newSolved);
                    console.log(`[ADVANCE] Stage ${stage} marked as solved locally. Progress:`, newSolved);
                }

                if (leaderboardManager) {
                    console.log(`[ADVANCE] Attempting to save stage ${stage} to database...`);
                    const result = await leaderboardManager.logSolve(stage);
                    
                    if (result.success) {
                        console.log(`[ADVANCE] Database save successful for stage ${stage}:`, result.reason || 'saved');
                    } else {
                        console.warn(`[ADVANCE] Database save failed for stage ${stage}, but continuing...`);
                    }
                }

                if (progressManager) {
                    await progressManager.logStageCompletion(`stage_${stage}`, `Stage ${stage} Complete`);
                }

                // Update UI first
                this.renderStagesGrid();
                this.updateProgress();

                // Update Stage 16
                updateStage16();

                // FIXED: Force refresh leaderboard
                setTimeout(() => {
                    renderLeaderboard();
                    renderLeaderboardStage16Big();
                }, 100);

                // Find next stage and advance
                const nextStage = this.getNextUnsolvedStage(stage + 1);
                
                if (nextStage) {
                    console.log(`[ADVANCE] Advancing from stage ${stage} to stage ${nextStage}`);
                    this.currentStage = nextStage; // Set current stage directly
                    this.renderCurrentStage();
                } else {
                    console.log(`[ADVANCE] All stages complete! Rendering grand prize.`);
                    this.renderGrandPrize();
                }
            }

            setCurrentStage(stage) {
                this.currentStage = stage;
                console.log(`[ADVANCE] Current stage set to: ${stage}`);
            }

            hideAllPanels() {
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('secondRiddlePanel').style.display = 'none';
                document.getElementById('successPanel').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('secondRiddleError').style.display = 'none';
            }

            // Use Supabase validation function instead of mock validation
            async validateAnswer(stage, step, answer) {
                console.log(`[VALIDATE] Validating stage ${stage}, step ${step}, answer: ${answer}`);
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/validate-answer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            stage: stage,
                            step: step,
                            answer: answer
                        })
                    });

                    console.log(`[VALIDATE] Response status: ${response.status}`);

                    if (!response.ok) {
                        console.error('Validation request failed:', response.status);
                        return false;
                    }

                    const data = await response.json();
                    console.log(`[VALIDATE] Response data:`, data);
                    return data.ok === true;
                } catch (error) {
                    console.error('Answer validation error:', error);
                    return false;
                }
            }

            fireConfetti() {
                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 180,
                        spread: 75,
                        origin: { y: 0.6 }
                    });
                    setTimeout(() => {
                        confetti({
                            particleCount: 120,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 }
                        });
                        confetti({
                            particleCount: 120,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 }
                        });
                    }, 250);
                }
            }

            renderCurrentStage() {
                console.log(`[renderCurrentStage] Starting render for stage ${this.currentStage}`);
                
                // Find the next unsolved stage starting from current stage
                let targetStage = this.currentStage;
                
                // If current stage is solved, find next unsolved stage
                while (targetStage <= CONFIG.total && this.isSolved(targetStage)) {
                    targetStage++;
                }
                
                // If we found an unsolved stage, use it
                if (targetStage <= CONFIG.total) {
                    this.currentStage = targetStage;
                } else {
                    // All stages are complete
                    this.renderCompletionMessage();
                    return;
                }

                const stageData = CONFIG.stages[this.currentStage];
                if (!stageData) {
                    this.renderCompletionMessage();
                    return;
                }

                console.log(`[renderCurrentStage] Rendering stage ${this.currentStage}`);

                document.querySelector('.stage-title').textContent = `${stageData.title} ‚Äî ${this.currentStage === 1 ? 'Start Your Journey' : 'Keep Going'}`;

                const videoElement = document.getElementById('currentVideo');
                if (stageData.yt) {
                    videoElement.src = `https://www.youtube.com/embed/${stageData.yt}?enablejsapi=1&origin=${window.location.origin}`;
                } else {
                    videoElement.src = '';
                }

                this.resetCurrentStageUI();

                if (this.hasTwoRiddles(this.currentStage) && this.isFirstRiddleSolved(this.currentStage) && !this.isSolved(this.currentStage)) {
                    console.log(`[ContestApp] Stage ${this.currentStage} first riddle already solved, showing second riddle`);
                    this.showSecondRiddle();
                }
            }

            getCurrentUnsolvedStage() {
                for (let i = 1; i <= CONFIG.total; i++) {
                    if (!this.isSolved(i)) return i;
                }
                return null;
            }

            renderCompletionMessage() {
                const panel = document.getElementById('currentStage');
                panel.innerHTML = `
                    <div class="stage-title">All Stages Complete üéâ</div>
                    <div class="stage-subtitle">Amazing work! You've solved every stage.</div>
                `;
            }

            renderGrandPrize() {
                const panel = document.getElementById('currentStage');
                panel.innerHTML = `
                    <div class="stage-title">üéâ CONGRATULATIONS! üéâ</div>
                    <div class="stage-subtitle">You've completed all 16 stages! You're eligible for the Grand Prize: 100,000 Turkish Airlines Miles!</div>
                `;
            }

            resetCurrentStageUI() {
                document.getElementById('answerInput').value = '';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('successPanel').style.display = 'none';
                document.getElementById('secondRiddlePanel').style.display = 'none';
                document.getElementById('inputSection').style.display = 'flex';
            }

            showSecondRiddle() {
                console.log(`[ContestApp] Showing second riddle for stage ${this.currentStage}`);
                
                const clueElement = document.getElementById('secondRiddleClue');
                const clueText = SECOND_RIDDLE_CLUES[this.currentStage] || "This is a placeholder second riddle. Enter any answer to continue for demo purposes.";
                clueElement.textContent = clueText;
                
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('successPanel').style.display = 'none';
                document.getElementById('secondRiddlePanel').style.display = 'block';
                document.getElementById('secondRiddleInput').value = '';
                document.getElementById('secondRiddleError').style.display = 'none';
            }

            renderStagesGrid() {
                const grid = document.getElementById('stagesGrid');
                grid.innerHTML = '';

                // Render stages 1-15 only (Stage 16 is separate)
                for (let i = 1; i <= 15; i++) {
                    const tile = this.createStageTile(i);
                    grid.appendChild(tile);
                }

                // Update Stage 16 separately
                updateStage16();
            }

            createStageTile(stage) {
                const solved = this.isSolved(stage);
                const unlocked = this.isUnlocked(stage);

                const tile = document.createElement('div');
                tile.className = `stage-tile ${solved ? 'solved' : unlocked ? 'open' : 'locked'}`;
                tile.dataset.stage = stage;

                const iconClass = solved ? 'solved' : unlocked ? 'open' : 'locked';
                const iconContent = solved ? '‚úì' : unlocked ? stage : 'üîí';
                const statusText = solved ? 'Solved' : unlocked ? 'Open' : 'Locked';

                let prizeText;
                if (stage === 15) {
                    prizeText = '<span class="prize-badge-line">50K Miles</span>';
                } else {
                    prizeText = '<span class="prize-badge-line">$50 Cash</span><span class="prize-badge-line">$100 GC</span>';
                }

                tile.innerHTML = `
                    <div class="prize-badge">
                        ${prizeText}
                    </div>
                    <div class="stage-icon ${iconClass}">${iconContent}</div>
                    <div class="stage-name">Stage ${stage}</div>
                    <div class="stage-status">${statusText}</div>
                `;

                if (unlocked && !solved) {
                    tile.addEventListener('click', () => this.openStageModal(stage));
                }

                return tile;
            }

            updateProgress() {
                const solved = this.solvedStages.length;
                const percentage = (solved / CONFIG.total) * 100;

                document.getElementById('progressCount').textContent = `${solved} / ${CONFIG.total} solved`;
                document.getElementById('progressFill').style.width = `${percentage}%`;
            }

            bindEvents() {
                document.getElementById('submitBtn').addEventListener('click', () => this.handleCurrentStageSubmit());
                document.getElementById('answerInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.handleCurrentStageSubmit();
                });
                document.getElementById('continueBtn').addEventListener('click', () => this.handleContinue());

                document.getElementById('secondRiddleSubmit').addEventListener('click', () => this.handleSecondRiddleSubmit());
                document.getElementById('secondRiddleInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.handleSecondRiddleSubmit();
                });

                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());

                document.getElementById('stageModal').addEventListener('click', (e) => {
                    if (e.target.id === 'stageModal') this.closeModal();
                });

                document.getElementById('signOutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    console.log('[UI] Sign out button clicked');
                    
                    const btn = e.target;
                    const originalText = btn.textContent;
                    
                    try {
                        btn.disabled = true;
                        btn.textContent = 'Signing out...';
                        
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Sign out timeout')), 5000);
                        });
                        
                        await Promise.race([
                            supabaseAuth.signOut(),
                            timeoutPromise
                        ]);
                        
                        console.log('[UI] Sign out completed successfully');
                        
                    } catch (error) {
                        console.error('[UI] Sign out error or timeout:', error);
                        
                        console.log('[UI] Forcing local sign out...');
                        
                        if (supabaseAuth) {
                            supabaseAuth.user = null;
                        }
                        
                        localStorage.removeItem("contest_solved_stages");
                        localStorage.removeItem("contest_first_riddle_solved");
                        
                        showLanding();
                        
                    } finally {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });
            }

            async handleCurrentStageSubmit() {
                const input = document.getElementById('answerInput');
                const submitBtn = document.getElementById('submitBtn');
                const answer = input.value.trim();

                if (!answer) {
                    this.showError('errorMessage', 'Please enter an answer.');
                    return;
                }

                submitBtn.disabled = true;
                this.hideError('errorMessage');

                const correct = await this.validateAnswer(this.currentStage, 1, answer);

                if (correct) {
                    if (this.hasTwoRiddles(this.currentStage)) {
                        console.log(`[ContestApp] Stage ${this.currentStage} first riddle solved`);
                        await this.handleFirstRiddleSolved(this.currentStage);
                        this.showSecondRiddle();
                    } else {
                        console.log(`[ContestApp] Stage ${this.currentStage} completely solved (single riddle)`);
                        this.fireConfetti();
                        setTimeout(() => {
                            this.markStageSolvedAndAdvance(this.currentStage);
                        }, 1000);
                    }
                } else {
                    this.showError('errorMessage', "That's not it. Watch & listen again üëÄ");
                }

                submitBtn.disabled = false;
            }

            async handleSecondRiddleSubmit() {
                const input = document.getElementById('secondRiddleInput');
                const submitBtn = document.getElementById('secondRiddleSubmit');
                const answer = input.value.trim();

                if (!answer) {
                    this.showError('secondRiddleError', 'Please enter an answer.');
                    return;
                }

                submitBtn.disabled = true;
                this.hideError('secondRiddleError');

                const correct = await this.validateAnswer(this.currentStage, 2, answer);

                if (correct) {
                    console.log(`[ContestApp] Stage ${this.currentStage} second riddle solved - stage complete!`);
                    
                    this.hideAllPanels();
                    this.fireConfetti();
                    
                    setTimeout(() => {
                        this.markStageSolvedAndAdvance(this.currentStage);
                    }, 1000);
                    
                } else {
                    this.showError('secondRiddleError', "That's not it. Watch & listen again üëÄ");
                }

                submitBtn.disabled = false;
            }

            async handleFirstRiddleSolved(stage) {
                console.log(`[ContestApp] Handling first riddle solved for stage ${stage}`);
                
                if (!this.isFirstRiddleSolved(stage)) {
                    const newFirstRiddleSolved = [...this.firstRiddleSolved, stage];
                    this.setFirstRiddleSolvedLocal(newFirstRiddleSolved);
                    console.log(`[ContestApp] First riddle progress updated:`, newFirstRiddleSolved);
                }

                this.fireConfetti();

                if (progressManager) {
                    await progressManager.logStageCompletion(`stage_${stage}_first`, `Stage ${stage} First Riddle`);
                }
            }

            handleContinue() {
                console.log(`[ContestApp] Continue button clicked, advancing from stage ${this.currentStage}`);
                
                const nextStage = this.getNextUnsolvedStage(this.currentStage + 1);
                if (nextStage) {
                    this.setCurrentStage(nextStage);
                    this.renderCurrentStage();
                } else {
                    this.renderGrandPrize();
                }
            }

            openStageModal(stage) {
                const stageData = CONFIG.stages[stage];
                if (!stageData) return;

                this.modalCurrentStage = stage;
                const modal = document.getElementById('stageModal');

                document.getElementById('modalTitle').textContent = stageData.title || `Stage ${stage}`;

                modal.style.display = 'flex';
            }

            closeModal() {
                const modal = document.getElementById('stageModal');
                modal.style.display = 'none';
                this.modalCurrentStage = null;
            }

            showError(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.style.display = 'block';
            }

            hideError(elementId) {
                document.getElementById(elementId).style.display = 'none';
            }
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            if (window.__appInitialized) {
                console.log('[INIT] App already initialized, skipping');
                return;
            }
            
            console.log('[INIT] Starting app initialization...');
            window.__appInitialized = true;

            // Initialize Supabase
            initializeSupabase();

            // Initialize Auth UI
            authUI = new AuthUI();
            window.authUI = authUI;

            // Initialize Contest App
            window.contestApp = new ContestApp();

            // Initialize modals
            howToPlayModal.init();
            termsModal.init();

            // Initialize Stage 16 on load
            updateStage16();

            // Footer link events for landing page
            document.getElementById('howToPlayLink').addEventListener('click', (e) => {
                e.preventDefault();
                howToPlayModal.open();
            });

            document.getElementById('termsLink').addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.open();
            });

            // Footer link events for game page
            document.getElementById('howToPlayLinkGame').addEventListener('click', (e) => {
                e.preventDefault();
                howToPlayModal.open();
            });

            document.getElementById('termsLinkGame').addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.open();
            });

            // Play Game Button Event
            document.getElementById('playGameBtn').addEventListener('click', () => {
                if (supabaseAuth && supabaseAuth.user) {
                    showGame();
                } else {
                    authUI.showModal();
                }
            });

            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('info-modal')) {
                    if (e.target.id === 'howToPlayModal') {
                        howToPlayModal.close();
                    } else if (e.target.id === 'termsModal') {
                        termsModal.close();
                    }
                }
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    howToPlayModal.close();
                    termsModal.close();
                }
            });

            // Check if user is already signed in
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    supabaseAuth.user = session.user;
                    showGame();
                } else {
                    showLanding();
                }
            });

            console.log('[INIT] App initialization complete');
        });
    </script>
</body>

</html>
